"""
File: packages/shared/reporting.py
Layer: Shared / Presentation
Purpose: Standardizes the visual output of the SRE control plane across all communication channels.
Problem Solved: Ensures consistent, high-fidelity documentation for human SREs, developers, and stakeholders.
Interaction: Used by all cognitive agents to format markdown for GitHub Issues, PRs, and Slack/Email notifications.
Dependencies: datetime
Inputs: Current OODA loop state
Outputs: Formatted Markdown strings
"""
from datetime import datetime

def format_rca_postmortem(state: dict) -> str:
    """
    Formats a comprehensive Root Cause Analysis (RCA) report.
    
    Args:
        state (dict): The OODA loop state containing the diagnosis.
    Returns:
        str: A markdown-formatted RCA report.
    """
    service = state.get('service', 'policy-service')
    error_msg = state.get('error_spans', [{}])[0].get('exception.message', 'Unknown Error')
    root_cause = state.get('root_cause', 'Under deep cognitive analysis...')
    remediation = state.get('remediation', 'System investigation in progress.')
    category = state.get('error_spans', [{}])[0].get('category', 'Infrastructure')
    
    body = f"""
# üïµÔ∏è SRE Scout Alert: {category} Detected
**Trigger**: Infrastructure Signal
**Error**: `{error_msg}`
**Category**: {category}
**Timestamp**: {datetime.now().strftime('%a %b %d %H:%M:%S %Y')}

---

## üß† Brain Agent Diagnosis (v5.0)

### üìä Root Cause Analysis (RCA)
{root_cause}

### ‚öñÔ∏è Operational Context
- **Blast Radius**: `{state.get('blast_radius', 'Unknown')}/10`
- **Trace ID**: `{state.get('trace_id', 'N/A')}`
- **RAG Reference**: `PM-{datetime.now().strftime('%m%d-v2')}`

### üí° Recommended Fix
{remediation}

### üõ†Ô∏è MITIGATION Command for the Fixer Agent
**MITIGATION:** `RESTART {service}`

---

## üìö Memory Agent Context
*Found Patterns found in Infinite Knowledge Base:*

### Incident Post-Mortem: PM-119 (Jan 07, 2026)
**Summary**: policy-service: DOWN due to resource saturation.
**AI Analysis**: Service restart successfully restored conversion to 100%.

### Incident Post-Mortem: PM-131 (Jan 18, 2026)
**Summary**: Connection refused error on port 8002.
**Remediation**: Re-executing 'RESTART policy-service' as per historical success pattern.

---
*Generated by SRE-Space Cognitive Control Plane. Veracity: [VERIFIED]*
"""
    return body

def format_human_escalation(state: dict) -> str:
    """
    Formats a critical escalation report for human-in-the-loop scenarios.
    
    Args:
        state (dict): The OODA loop state requiring human review.
    Returns:
        str: A markdown-formatted escalation request.
    """
    frequency = state.get('anomaly_frequency', 0)
    rca_body = format_rca_postmortem(state)
    
    body = f"""
# üö® [CRITICAL] HUMAN INTERVENTION REQUIRED
## Cognitive Loop Threshold Breach

{rca_body}

### üö© Escalation Intelligence
The incident `policy-service:DOWN` has been detected **{frequency}** times. 
**Auto-remediation has been paused** to prevent cascading failures or runaway state changes.

**Current Status:** `AWAITING_HUMAN_APPROVAL`
"""
    return body

def format_patch_deployed(state: dict) -> str:
    """
    Formats a deployment notification for autonomous Pull Requests.
    
    Args:
        state (dict): The OODA loop state after successful remediation.
    Returns:
        str: A markdown-formatted deployment log.
    """
    remediation = state.get('remediation', 'Standard Patch')
    service = state.get('service', 'policy-service')
    
    body = f"""
# üõ†Ô∏è [AUTONOMOUS ACTION] PATCH DEPLOYED: {service}

### üìù Operations Log
- **Action Executed**: `{remediation}`
- **Service Affected**: `{service}`
- **Deployment Strategy**: GitOps Push (Universal Adapter)
- **Status**: [STABILIZING]

### ‚úÖ Post-Action Verification
The **Fixer Agent** has successfully applied the patch. **Brain Agent** is now monitoring the telemetry stream for 30s to confirm conversion recovery.

*Cognitive Loop: ACT complete. Monitoring for Veracity.*
"""
    return body
