version: '3.8'

services:
  # --- INFRASTRUCTURE ---
  kafka:
    image: apache/kafka:latest
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_NUM_PARTITIONS=3
    healthcheck:
      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092" ]
      interval: 10s
      timeout: 10s
      retries: 5

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "4317:4317"
    environment:
      - COLLECTOR_OTLP_ENABLED=true

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    volumes:
      - ./infra/otel-config.yaml:/etc/otelcol-contrib/config.yaml
    ports:
      - "4318:4318"
    environment:
      - NEW_RELIC_LICENSE_KEY=${NEW_RELIC_LICENSE_KEY}
    depends_on:
      - jaeger

  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/data

  # --- MICROSERVICES ---
  quote-service:
    build: ./apps/quote-service
    ports:
      - "8001:8001"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    depends_on:
      kafka:
        condition: service_healthy

  policy-service:
    build: ./apps/policy-service
    ports:
      - "8002:8002"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    depends_on:
      kafka:
        condition: service_healthy

  user-service:
    build: ./apps/user-service
    ports:
      - "8003:8003"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
    depends_on:
      - otel-collector

  mock-api:
    build: ./apps/mock-api
    ports:
      - "8080:8080"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318/v1/traces
    depends_on:
      - otel-collector

  frontend:
    build: ./apps/frontend
    ports:
      - "3001:80"
    depends_on:
      - mock-api

  # --- AGENTS (Final Unified Build) ---
  scout:
    build:
      context: .
      dockerfile: ./agents/Dockerfile
    dns:
      - 8.8.8.8
    command: [ "python", "agents/scout.py" ]
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - history_data:/app/shared/history
      - .:/app

  brain:
    build:
      context: .
      dockerfile: ./agents/Dockerfile
    dns:
      - 8.8.8.8
    command: [ "python", "agents/brain.py" ]
    env_file: .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - history_data:/app/shared/history
      - .:/app

  memory:
    build:
      context: .
      dockerfile: ./agents/Dockerfile
    dns:
      - 8.8.8.8
    command: [ "python", "agents/memory.py" ]
    env_file: .env
    depends_on:
      - chromadb
    volumes:
      - history_data:/app/shared/history
      - .:/app

  fixer:
    build:
      context: .
      dockerfile: ./agents/Dockerfile
    dns:
      - 8.8.8.8
    command: [ "python", "agents/fixer.py" ]
    env_file: .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app/monorepo
      - history_data:/app/shared/history
      - .:/app
    depends_on:
      - brain

volumes:
  chroma-data:
  history_data:
